<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="node_modules/vss-web-extension-sdk/lib/VSS.SDK.min.js"></script>
    <script>
        VSS.init();

        VSS.ready(function() {
            VSS.require(["VSS/Service", "ReleaseManagement/Core/RestClient", "TFS/WorkItemTracking/Services", "TFS/Build/RestClient", "VSS/Controls", "VSS/Controls/StatusIndicator", "TFS/WorkItemTracking/RestClient"],
                function(vss_service, release_mgmt_api, work_item_track_services, build_api, Controls, StatusIndicator, work_item_tracking_api) {

                    console.log('Web context: ', VSS.getWebContext());
                    var artifacts_container = document.getElementById('artifacts');
                    var wait_control = Controls.create(StatusIndicator.WaitControl, artifacts_container, {
                        cancellable: false
                    });

                    wait_control.startWait();

                    var release_mgmt_client = vss_service.getCollectionClient(release_mgmt_api.ReleaseHttpClient);
                    var build_client = vss_service.getCollectionClient(build_api.BuildHttpClient2);
                    var work_item_tracking_client = vss_service.getCollectionClient(work_item_tracking_api.WorkItemTrackingHttpClient2_2);

                    work_item_track_services.WorkItemFormService.getService()
                    .then(function(service) {
                        return Promise.all([
                            service.getFieldValue("Associated Context"),
                            service.getFieldValue("System.Title")
                        ]);
                    }).then(function(results) {
                        var release_info = JSON.parse(results[0]);
                        var approvalType = results[1].split("-")[0].toLowerCase();

                        return Promise.all([
                            release_info,
                            approvalType,
                            release_mgmt_client.getRelease(VSS.getWebContext().project.id, release_info.release_id)
                        ]);
                    }).then(function(results) {
                        var release_info = results[0];
                        var approvalType = results[1];
                        var release = results[2];
                        var user_id = VSS.getWebContext().user.id;
                        console.log('Release info: ', release_info);
                        console.log('User id: ', user_id);

                        for (var i = 0; i < release_info.attachments.length; i++) {
                            var attachment = release_info.attachments[i];
                            var downloadUrl = attachment.url;
                            var tr = document.createElement('tr');
                                var td = document.createElement('td');
                                    var link = document.createElement('a');
                                        link.innerHTML = downloadUrl.split("fileName=")[1];
                                    td.appendChild(link);
                                tr.style.cursor = "pointer";
                                tr.addEventListener('click', function() {
                                    window.open(downloadUrl, "_blank");
                                });
                                tr.appendChild(td);
                            
                            artifacts_container.children[0].children[0].appendChild(tr);
                            if (i !== artifacts.length - 1) {
                                artifacts_container.appendChild(document.createElement('br'));
                            }
                        }

                        // Pre-Deploy or Post-Deploy Approvals
                        var approvals = (approvalType === "pre") ? release.environments[release_info.indexOfInterest].preDeployApprovals : release.environments[release_info.indexOfInterest].postDeployApprovals;

                        console.log(`Release: `, release);
                        var br = document.createElement("br");
                        var approveBtn = document.createElement("button");
                            approveBtn.id = "approve";
                            approveBtn.innerHTML = "Approve";
                            approveBtn.style.backgroundColor = "yellowgreen";
                            approveBtn.style.color = "black";
                            approveBtn.addEventListener("click", function() {
                                for (let i = 0; i < approvals.length; i++) {
                                    const approval = approvals[i];
                                    if (approval.approver.id === user_id) {
                                        if (approval.status === "approved") {
                                            alert("Already approved");
                                        } else {
                                            approval.approvedBy = user_id;
                                            approval.status = 'approved';
                                            release_mgmt_client.updateReleaseApproval(approval, VSS.getWebContext().project.id, approval.id)
                                            .then(approval => {
                                                console.log('Updated approval: ', approval);
                                                if (approval && approval.id) {
                                                    alert("Approval Operation: Success");
                                                } else {
                                                    alert("Approval Operation: Failure");
                                                }
                                            });
                                        }
                                    }
                                }
                            });
                        var rejectBtn = document.createElement("button");
                            rejectBtn.id = "reject";
                            rejectBtn.innerHTML = "Reject";
                            rejectBtn.style.backgroundColor = "firebrick";
                            rejectBtn.style.color = "white";
                            rejectBtn.addEventListener("click", function() {
                                for (let i = 0; i < approvals.length; i++) {
                                    const approval = approvals[i];
                                    if (approval.approver.id === user_id) {
                                        if (approval.status === "approved") {
                                            alert("Already approved");
                                        } else {
                                            approval.approvedBy = user_id;
                                            approval.status = 'rejected';
                                            release_mgmt_client.updateReleaseApproval(approval, VSS.getWebContext().project.id, approval.id)
                                            .then(approval => {
                                                console.log('Updated approval: ', approval);
                                                if (approval && approval.id) {
                                                    alert("Reject Operation: Success");
                                                } else {
                                                    alert("Reject Operation: Failure");
                                                }
                                            });
                                        }
                                    }
                                }
                            });
                        document.getElementById("buttons-container").appendChild(rejectBtn);
                        document.getElementById("buttons-container").appendChild(approveBtn);
                        wait_control.endWait();
                        return build_client.getArtifacts(release.artifacts["0"].definitionReference.version.id, VSS.getWebContext().project.id, 'Build');
                    }).then(function(artifacts) {
                        console.log('Artifacts: ', artifacts);
                        // for (var i = 0; i < artifacts.length; i++) {
                        //     var current_artefact = artifacts[i];
                        //     var downloadUrl = current_artefact.resource.downloadUrl;
                        //     var tr = document.createElement('tr');
                        //         var td = document.createElement('td');
                        //             var link = document.createElement('a');
                        //                 // link.href = downloadUrl;
                        //                 link.innerHTML = current_artefact.name;
                        //             td.appendChild(link);
                        //         tr.style.cursor = "pointer";
                        //         tr.addEventListener('click', function() {
                        //             window.open(downloadUrl, "_blank");
                        //         });
                        //         tr.appendChild(td);
                            
                        //     artifacts_container.children[0].children[0].appendChild(tr);
                        //     if (i !== artifacts.length - 1) {
                        //         artifacts_container.appendChild(document.createElement('br'));
                        //     }
                        // }
                        
                        return release_mgmt_client.getApprovals(VSS.getWebContext().project.id);
                    }).then(function(approvals) {
                        console.log('Approvals: ', approvals);
                        return work_item_track_services.WorkItemFormService.getService();
                    }).then(function (service) {
                        return Promise.all([
                            service.getFields(),
                            service.getFieldValue("Attached File Count"),
                            service.getFieldValue("Hyperlink Count"),
                            service.getFieldValue("Remote Link Count"),
                            service.getFieldValue("Related Links"),
                            service.getFieldValue("Attached Files"),
                            service.getFieldValue("Linked Files"),
                            service.getFieldValue("BIS Links"),
                            service.getFieldValue("Related Link Count")
                        ]);
                    }).then(function (results) {
                        var fields = results[0];
                        var attachedFileCount = results[1];
                        var relatedLinks = results[4];
                        var attachedFiles = results[5];
                        var linkedFiles = results[6];
                        var bisLinks = results[7];
                        console.log('Fields: ', fields);
                        console.log('Attached File Count: ', attachedFileCount);
                        console.log('Related Links: ', relatedLinks);
                        console.log('Attached Files: ', attachedFiles);
                        console.log('Linked Files: ', linkedFiles);
                        console.log('BIS Links: ', bisLinks);
                    });
                });
        });
    </script>
</head>
<body style="padding: 2.5%;">
    <div id="artifacts" style="width: 100%; height: 75px; overflow: auto;">
        <table border="1" cellpadding="5" style="width: 100%;">
            <tbody>
                <!-- <tr><td>Hello</td></tr>
                <tr><td>World</td></tr>
                <tr><td>Hello</td></tr>
                <tr><td>World</td></tr>
                <tr><td>Hello</td></tr>
                <tr><td>World</td></tr> -->
            </tbody>
        </table>
    </div>
    <br/>
    <div id="buttons-container"></div>
    <!-- <button id="reject" style="background-color: firebrick; color: white">Reject</button>
    <button id="approve" style="background-color: yellowgreen; color: black">Approve</button> -->
</body>
</html>