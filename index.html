<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="node_modules/vss-web-extension-sdk/lib/VSS.SDK.min.js"></script>
    <script>
        VSS.init();

        VSS.ready(function() {
            VSS.require([
                "VSS/Service", "ReleaseManagement/Core/RestClient", "TFS/WorkItemTracking/Services", 
                "TFS/Build/RestClient", "VSS/Controls", "VSS/Controls/StatusIndicator", 
                "TFS/WorkItemTracking/RestClient"
            ], function(vss_service, release_mgmt_api, work_item_track_services, 
                build_api, Controls, StatusIndicator, 
                work_item_tracking_api) {
                    console.log('Web context: ', VSS.getWebContext());

                    // retrieve the 'div' element that will display all the attachments
                    var attachments_container = document.getElementById('attachments');
                    var buttons_container = document.getElementById("buttons-container");
                    
                    // Retrieve the project id and user id (current user's) from 
                    // the webcontext of the extension for later 
                    // use.
                    var project_id = VSS.getWebContext().project.id;
                    var user_id = VSS.getWebContext().user.id;

                    // VSTS' wait control (A.K.A. Loading Screen)
                    var wait_control = Controls.create(StatusIndicator.WaitControl, attachments_container, {
                        // Since this is just a normal loading screen that notifies 
                        // the user that the extension is loading in the background, 
                        // it should not be cancellable
                        cancellable: false
                    });

                    // Start showing the loading screen
                    wait_control.startWait();

                    // Retrieve the relevant REST API clients from the VSTS Web Extension SDK
                    var release_mgmt_client = vss_service.getCollectionClient(release_mgmt_api.ReleaseHttpClient);
                    var build_client = vss_service.getCollectionClient(build_api.BuildHttpClient2);
                    var work_item_tracking_client = vss_service.getCollectionClient(work_item_tracking_api.WorkItemTrackingHttpClient2_2);

                    // Get the work item service for the current work item
                    work_item_track_services.WorkItemFormService.getService()
                    .then(function(service) {
                        // Retrieve the "associated context" fields of the current work item
                        return Promise.all([
                            service.getFieldValue("Associated Context")
                        ]);
                    }).then(function(results) {
                        // "Associated Context" contains the data stored by the release task 
                        // into the current work item in the format of a JSON object 
                        // stringified into a string value

                        // Parse out the JSON data in "Associated Context"
                        var release_info = JSON.parse(results[0]);

                        // Using the release id in the JSON data, 
                        // retrieve the release for which an approval / rejection 
                        // is to be made
                        //
                        // Hence, transfer the JSON data and the release to the next 
                        // Promise chain
                        return Promise.all([
                            release_info,
                            release_mgmt_client.getRelease(project_id, release_info.release_id)
                        ]);
                    }).then(function(results) {
                        // Store the JSON data and release object 
                        // from the previous Promise chain 
                        // into the following variables
                        var release_info = results[0];
                        var release = results[1];

                        // Retrieve the approval type and attachments 
                        // from the JSON data
                        var approval_type = release_info.type;
                        var attachments = release_info.attachments;

                        console.log('Release info: ', release_info);

                        // For each attachment,
                        // 1. Create a hyperlink element (<a>)
                        //    - This link should display the name of the attachment
                        // 2. Create a table cell to contain this hyperlink element
                        // 3. Create a table row to contain the table cell created in step 2.
                        //    - When mouseover this table row, the cursor should change into a hand
                        //    - When the table row is clicked, it should trigger the download of the attachment
                        //
                        // NOTE: It is deliberate that the hyperlink does not contain a link itself, 
                        //       as doing so will cause the download action to be triggered twice.
                        //
                        //       Table row has been programmed to accept user clicks as this will 
                        //       make it easier for users to click, compared to the hyperlink which 
                        //       occupies lesser space on the screen.
                        for (var i = 0; i < attachments.length; i++) {
                            var current_attachment = attachments[i];
                            var download_url = current_attachment.url;
                            var tr = document.createElement('tr');
                                var td = document.createElement('td');
                                    var link = document.createElement('a');
                                        link.innerHTML = download_url.split("fileName=")[1];
                                    td.appendChild(link);
                                // The following is so that the cursor will change into 
                                // a hand when the user hover their mouse over the table row
                                tr.style.cursor = "pointer";
                                tr.addEventListener('click', function() {
                                    window.open(download_url, "_blank");
                                });
                                tr.appendChild(td);
                            attachments_container.children[0].children[0].appendChild(tr);
                        }

                        // Based on the approval type, retrieve the appropriate approvals 
                        // to be approved / rejected.
                        var approvals = (approval_type.toLowerCase() === "pre") ? release.environments[release_info.indexOfInterest].preDeployApprovals : release.environments[release_info.indexOfInterest].postDeployApprovals;

                        console.log(`Release: `, release);
                        // Create the "Approve" and "Reject" buttons
                        var approveBtn = document.createElement("button");
                            approveBtn.id = "approve";
                            approveBtn.innerHTML = "Approve";
                            approveBtn.style.backgroundColor = "yellowgreen";
                            approveBtn.style.color = "black";
                            approveBtn.addEventListener("click", function() {
                                for (let i = 0; i < approvals.length; i++) {
                                    const approval = approvals[i];
                                    if (approval.approver.id === user_id) {
                                        if (approval.status === "approved") {
                                            alert(approval_type + "-Deploy Approval already approved");
                                        } else {
                                            approval.approvedBy = user_id;
                                            approval.status = 'approved';
                                            release_mgmt_client.updateReleaseApproval(approval, project_id, approval.id)
                                            .then(approval => {
                                                console.log('Updated approval: ', approval);
                                                if (approval && approval.id) {
                                                    alert(approval_type + "-Deploy Approval Operation: Success");
                                                } else {
                                                    alert(approval_type + "-Deploy Approval Operation: Failure");
                                                }
                                            });
                                        }
                                    }
                                }
                            });
                        var rejectBtn = document.createElement("button");
                            rejectBtn.id = "reject";
                            rejectBtn.innerHTML = "Reject";
                            rejectBtn.style.backgroundColor = "firebrick";
                            rejectBtn.style.color = "white";
                            rejectBtn.addEventListener("click", function() {
                                for (let i = 0; i < approvals.length; i++) {
                                    const approval = approvals[i];
                                    if (approval.approver.id === user_id) {
                                        if (approval.status === "approved") {
                                            alert("Already approved");
                                        } else {
                                            approval.approvedBy = user_id;
                                            approval.status = 'rejected';
                                            release_mgmt_client.updateReleaseApproval(approval, project_id, approval.id)
                                            .then(approval => {
                                                console.log('Updated approval: ', approval);
                                                if (approval && approval.id) {
                                                    alert(approval_type + "-Deploy Reject Operation: Success");
                                                } else {
                                                    alert(approval_type + "-Deploy Reject Operation: Failure");
                                                }
                                            });
                                        }
                                    }
                                }
                            });
                        
                        // Append the buttons to the 'div' element designated to 
                        // hold these buttons.
                        buttons_container.appendChild(rejectBtn);
                        buttons_container.appendChild(approveBtn);

                        // The DOM has been set up and the UI is ready to be presented 
                        // to the user. Stop the loading screen.
                        wait_control.endWait();
                        return work_item_track_services.WorkItemFormService.getService();
                    }).then(function (service) {
                        return Promise.all([
                            service.getFields(),
                            service.getFieldValue("Attached File Count"),
                            service.getFieldValue("Related Links"),
                            service.getFieldValue("Attached Files"),
                            service.getFieldValue("Linked Files"),
                            service.getFieldValue("BIS Links"),
                            service.getFieldValue("Related Link Count")
                        ]);
                    }).then(function (results) {
                        var fields = results[0];
                        var attachedFileCount = results[1];
                        var relatedLinks = results[2];
                        var attachedFiles = results[3];
                        var linkedFiles = results[4];
                        var bisLinks = results[5];
                        var relatedLinksCount = results[6];
                        console.log('Fields: ', fields);
                        console.log('Attached File Count: ', attachedFileCount);
                        console.log('Related Links: ', relatedLinks);
                        console.log('Attached Files: ', attachedFiles);
                        console.log('Linked Files: ', linkedFiles);
                        console.log('BIS Links: ', bisLinks);
                    });
            });
        });
    </script>
</head>
<body style="padding: 2.5%;">
    <div id="attachments" style="width: 100%; height: 75px; overflow: auto;">
        <table border="1" cellpadding="5" style="width: 100%;">
            <tbody>
            </tbody>
        </table>
    </div>
    <br/>
    <div id="buttons-container"></div>
</body>
</html>